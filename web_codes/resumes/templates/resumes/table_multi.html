{% extends "recruit_manager/table_basic.html" %}
{% load static %}
{% block content %}
<div class="table-responsive">

  <div class="text-primary" id="text_company_name"> Select Post </div>

  <table class="table table-bordered" id="dataTable_post" width="100%" cellspacing="0">
    <thead>
      <tr>
        <th>ID</th>
        <th>Company</th>
        <th>Department</th>
        <th>Name</th>
      </tr>
    </thead>
  </table>

  <HR style="border:3 double #987cb9" width="90%" color=#987cb9 SIZE=3>

  <table border="0" cellspacing="5" cellpadding="5">
    <tbody>
      <tr>
        <td>Minimum age:</td>
        <td><input type="text" id="min_age" name="min_age"></td>

        <td>Minimum degree:</td>
        <td><input type="text" id="min_degree" name="min_degree"></td>

        <td>Gender:</td>
        <td><input type="checkbox" id="gender_f" name="gender_f" checked>Female</td>
      </tr>
      <tr>
        <td>Maximum age:</td>
        <td><input type="text" id="max_age" name="max_age"></td>

        <td>Maximum degree:</td>
        <td><input type="text" id="max_degree" name="max_degree"></td>

        <td></td>
        <td><input type="checkbox" id="gender_m" name="gender_m" checked>Male</td>
      </tr>
    </tbody>
  </table>


  <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
    <thead>
      <tr>
        <th>CK</th>
        <th>CID</th>
        <th>ID</th>
        <th>Name</th>
        <th>Gender</th>
        <th>Age</th>
        <th>Phone</th>
        <th>Email</th>
        <th>School</th>
        <th>Degree</th>
        <th>Major</th>
        <th>Stat</th>
      </tr>
    </thead>
  </table>

  <form>
    <button type='button' id='id_button_submit'>SUBMIT</button>
  </form>

</div>
{% endblock %}

{% block extra_js %}
<script>
 $(document).ready(function() {
   var resume_selected = [];
   var post_selected = false;
   var post_selected_value = 0;

   var table = $('#dataTable').DataTable({
     "processing": true,
     "serverSide": true,

     "ajax": {
       "url": "/api/resumes/",
       "type": "GET",
       "data": function (d) {
         d.degree_min = $('#min_degree').val();
         d.degree_max = $('#max_degree').val();

         d.age_min = $('#min_age').val();
         d.age_max = $('#max_age').val();

         d.gender_m = $('#gender_m:checked').val();
         d.gender_f = $('#gender_f:checked').val();
       },
     },

     "rowCallback": function(row, data) {
       if ($.inArray(data.DT_RowId.toString(), resume_selected) !== -1 ) {
         $(row).addClass('selected');
       }

     },

     "columns": [
       {"data": null,
        "checkboxes": {
        },
       },
       {"data": "candidate_id",
        "visible": false},
       {"data": "id"},
       {"data": "username"},
       {"data": "gender"},
       {"data": "age"},
       {"data": "phone_number"},
       {"data": "email"},
       {"data": "school"},
       {"data": "degree"},
       {"data": "major"},
       {"data": "stat",
        render: function(data, type, row, meta) {
          if (row.stat) {
            return "\
  <button class=\"btn btn-success btn-icon-split border-0\" id=\"stage\">\
    <span class=\"icon text-white-50\">\
      <i class=\"fas fa-check\"></i></span>\
    <span class=\"text\">Interviewed</span>\
  </button>";
          }

          if (row.candidate_id) {
            var url="{% url 'app_manager:t_interview_api' 1234 %}".replace(/1234/, row.candidate_id);

            var str = "\
  <form action=" + url + " method='GET'>\
    <button class=\"btn btn-info btn-icon-split border-0\" id=\"stage\">\
      <span class=\"icon text-white-50\">\
        <i class=\"fas fa-arrow-right\"></i></span>\
      <span class=\"text\">Prepare Interview</span>\
    </button>\
  </form>";
            return str;
          }

          return "ABC";
        }
       },
     ],
   });

   var table_post = $('#dataTable_post').DataTable({
     "lengthChange": false,
     "pageLength" : 5,

     "processing": true,
     "serverSide": true,

     "ajax": {
       "url": "/api/posts/",
       "type": "GET",
     },

     "rowCallback": function(row, data) {

       if ((post_selected === true) && (data.DT_RowId == post_selected_value)) {
         $(row).addClass('selected');
       }
     },

     "columns": [
       {"data": "id"},
       {"data": "department.company.name"},
       {"data": "department.name"},
       {"data": "name"},
     ],
   });

   $('#min_degree, #max_degree, #min_age, #max_age').keyup(function() {
     table.draw();
   });

   $('#gender_m, #gender_f').on('click', function() {
     table.draw();
   });

   $('#dataTable tbody').on('click', 'tr', function() {
     var id = this.id;
     var index = $.inArray(id, resume_selected);

     if ( index === -1 ) {
       resume_selected.push(id);
     } else {
       resume_selected.splice(index, 1);
     }

     $(this).toggleClass('selected');
   });

   // post table
   $('#dataTable_post tbody').on('click', 'tr', function() {
     var id = this.id;

     if (id === post_selected_value && post_selected === true) {
       $(this).toggleClass('selected');
       post_selected = false;
     } else {
       $(this).toggleClass('selected');

       if (post_selected === true) {
         $('tr#' + post_selected_value).toggleClass('selected');
       }
       post_selected = true;
       post_selected_value = id;

       var tr = document.getElementById(id);
       document.getElementById("text_company_name").innerHTML = tr.innerText;
     }
   });

   function getCookie(name) {
     var cookieValue = null;
     if (document.cookie && document.cookie !== '') {
       var cookies = document.cookie.split(';');
       for (var i = 0; i < cookies.length; i++) {
         var cookie = cookies[i].trim();
         // Does this cookie string begin with the name we want?
         if (cookie.substring(0, name.length + 1) === (name + '=')) {
           cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
           break;
         }
       }
     }
     return cookieValue;
   }

   $('#id_button_submit').on('click', function() {
     console.log(post_selected_value);
     console.log(resume_selected);

     // submit to interview interface
     for (var i = 0; i < resume_selected.length; i++) {
       var xhr = new XMLHttpRequest();
       xhr.open("POST", "/api/interviews/");
       xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
       var csrftoken = getCookie('csrftoken');

       xhr.setRequestHeader("X-CSRFToken", csrftoken);

       data = {"resume": Number(resume_selected[i]),
               "post": Number(post_selected_value),
               "is_active":true,
               "status": 0,
               "result":"Pending",
       };

       console.log(data);
       xhr.send(JSON.stringify(data));
       xhr.onloadend = function() {
         //done
       };
     }
   });
 });
</script>
{% endblock%}
